<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

    <mapper namespace="com.example.demo.member.MemberMapper">
    	<insert id="setJoin" parameterType="MemberVO">
    		INSERT INTO member (username, password, name, email, phone, enabled)
    		VALUES(#{username}, #{password}, #{name}, #{email}, #{phone}, #{enabled})
    	</insert>
    	
    	<insert id="setMemberRole" parameterType="java.util.Map">
    		INSERT INTO member_role (username, id) 
    		VALUES (#{username}, (select id from role where roleName=#{roleName}))
    	</insert>
    	
    	<select id="checkUsername" parameterType="MemberVO" resultType="java.lang.Long">
    		select count(username) from member where username = #{username}
    	</select>
    	
    	<insert id="setMemberFile" parameterType="MemberFileVO">
    		INSERT INTO memberfile VALUES(NULL,#{username},#{fileName},#{oriName})
    	</insert>
    	<select id="getLogin" parameterType="MemberVO" resultMap="Result">
    		SELECT M.*, R.* 
			FROM member M LEFT JOIN member_role MR
			ON M.username=MR.username
			INNER JOIN role R
			ON MR.id = R.id
			WHERE M.username=#{username}
    	</select>
    	<!-- 스프링 시큐리티에서 비번 일치하는 지 확인 할 것이다 근데 결과값이 여러개 나온다 -->
    	<resultMap type="MemberVO" id="Result">
    		<id column="username" property="username"/>
			<result column="password" property="password"/>
			<result column="name" property="name"/>
			<result column="email" property="email"/>
			<result column="phone" property="phone"/>
			<result column="enabled" property="enabled"/>
			<collection property="roles" javaType="java.util.List" ofType="RoleVO">
				<result column="id" property="id"/>
				<result column="roleName" property="roleName"/>
			</collection>
    	</resultMap>
    
    </mapper>